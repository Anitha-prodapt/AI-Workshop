<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IoT Practice — Device Monitoring Dashboard</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Optional: Smooth card animations */
    .fade-in { animation: fade-in 0.3s ease-in-out; }
    @keyframes fade-in { from { opacity: 0; transform: translateY(6px);} to { opacity: 1; transform: none;} }

    /* Scrollbars for alerts */
    .thin-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
    .thin-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <!-- App Container -->
  <div class="max-w-7xl mx-auto p-4 sm:p-6">
    <!-- Header -->
    <header class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-4">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">IoT Device Monitoring Dashboard</h1>
        <p class="text-sm text-slate-500">Self-contained demo for an IoT practice team — Tailwind + Vanilla JS</p>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <button id="addDeviceBtn" class="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 shadow">+ Add Demo Device</button>
        <div class="flex items-center gap-2 bg-white rounded-xl shadow px-3 py-2">
          <label for="refreshSelect" class="text-sm text-slate-600">Auto‑refresh</label>
          <select id="refreshSelect" class="text-sm bg-transparent focus:outline-none">
            <option value="off">Off</option>
            <option value="5000">Every 5s</option>
            <option value="10000">Every 10s</option>
            <option value="30000">Every 30s</option>
            <option value="60000">Every 60s</option>
          </select>
        </div>
        <button id="refreshNowBtn" class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 shadow">Refresh Now</button>
      </div>
    </header>

    <!-- Summary Stats -->
    <section id="summary" class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
      <div class="bg-white rounded-2xl shadow p-4">
        <p class="text-xs uppercase text-slate-500">Total Devices</p>
        <p id="statTotal" class="text-2xl font-semibold">0</p>
      </div>
      <div class="bg-white rounded-2xl shadow p-4">
        <p class="text-xs uppercase text-slate-500">Online</p>
        <p id="statOnline" class="text-2xl font-semibold text-emerald-600">0</p>
      </div>
      <div class="bg-white rounded-2xl shadow p-4">
        <p class="text-xs uppercase text-slate-500">Offline</p>
        <p id="statOffline" class="text-2xl font-semibold text-rose-600">0</p>
      </div>
      <div class="bg-white rounded-2xl shadow p-4">
        <p class="text-xs uppercase text-slate-500">Alerts</p>
        <p id="statAlerts" class="text-2xl font-semibold text-amber-600">0</p>
      </div>
    </section>

    <!-- Main Content: Devices + Alerts -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 items-start">
      <!-- Devices Grid -->
      <section class="xl:col-span-2">
        <div id="deviceGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>

      <!-- Alerts Panel -->
      <aside class="bg-white rounded-2xl shadow p-4 max-h-[70vh] overflow-auto thin-scrollbar">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold flex items-center gap-2">Alerts
            <span id="alertCountBadge" class="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-full">0</span>
          </h2>
          <div class="flex gap-2">
            <button id="clearAlertsBtn" class="text-xs px-2 py-1 rounded-lg bg-slate-100 hover:bg-slate-200">Clear</button>
            <button id="seedAlertsBtn" class="text-xs px-2 py-1 rounded-lg bg-slate-100 hover:bg-slate-200">Seed</button>
          </div>
        </div>
        <ul id="alertList" class="space-y-2"></ul>
      </aside>
    </div>
  </div>

  <template id="deviceCardTpl">
    <div class="device-card bg-white rounded-2xl shadow p-4 fade-in flex flex-col gap-3">
      <div class="flex items-start justify-between">
        <div>
          <h3 class="device-name text-base font-semibold">Device Name</h3>
          <p class="device-type text-xs text-slate-500">Type</p>
        </div>
        <span class="device-status inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600">offline</span>
      </div>

      <div class="grid grid-cols-2 gap-3 text-sm">
        <div>
          <p class="text-slate-500">Sensor</p>
          <p class="font-mono device-sensor">—</p>
        </div>
        <div>
          <p class="text-slate-500">Battery</p>
          <p class="font-mono device-battery">—</p>
        </div>
        <div>
          <p class="text-slate-500">Last Seen</p>
          <p class="font-mono device-lastseen">—</p>
        </div>
        <div>
          <p class="text-slate-500">Power</p>
          <p class="font-mono device-power">—</p>
        </div>
      </div>

      <div class="flex flex-wrap gap-2 mt-1">
        <button class="btn-toggle px-3 py-2 rounded-xl bg-slate-800 text-white text-sm hover:bg-slate-900">Toggle Power</button>
        <button class="btn-reboot px-3 py-2 rounded-xl bg-indigo-600 text-white text-sm hover:bg-indigo-700">Reboot</button>
        <button class="btn-simulate px-3 py-2 rounded-xl bg-slate-100 text-slate-700 text-sm hover:bg-slate-200">Simulate</button>
      </div>
    </div>
  </template>

  <template id="alertItemTpl">
    <li class="rounded-xl border border-slate-200 p-3 flex gap-3">
      <div class="shrink-0 w-2 rounded-lg" data-severity-bar></div>
      <div class="grow">
        <div class="flex items-center justify-between">
          <p class="font-semibold text-sm" data-title>Alert</p>
          <p class="text-xs text-slate-500" data-time>now</p>
        </div>
        <p class="text-sm" data-body></p>
        <div class="mt-2 flex items-center gap-2">
          <span class="text-[10px] uppercase tracking-wide px-2 py-0.5 rounded-full" data-severity-pill>sev</span>
          <button class="text-xs px-2 py-1 rounded-md bg-slate-100 hover:bg-slate-200" data-dismiss>Dismiss</button>
        </div>
      </div>
    </li>
  </template>

  <script>
    // --- Utilities --- //
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
    const nowIso = () => new Date().toISOString();
    const fmtTime = (d) => new Date(d).toLocaleString();

    function rand(min, max) { return Math.random() * (max - min) + min; }
    function randi(min, max) { return Math.floor(rand(min, max + 1)); }
    function sample(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    function clamp(v, min, max) { return Math.min(max, Math.max(min, v)); }

    // --- Device Model --- //
    const DEVICE_TYPES = {
      temperature: {
        name: 'Temperature Sensor',
        genReading(d) {
          // baseline around 22-28C, with occasional spikes
          const drift = rand(-0.6, 0.8);
          d.temp = clamp((d.temp ?? rand(20, 28)) + drift, -10, 80);
          d.humidity = clamp((d.humidity ?? rand(35, 60)) + rand(-1, 1.5), 5, 95);
          return `${d.temp.toFixed(1)}°C / ${d.humidity.toFixed(0)}%RH`;
        },
      },
      motion: {
        name: 'Motion Detector',
        genReading(d) {
          const detected = Math.random() < 0.15; // 15% chance
          d.motion = detected;
          return detected ? 'Motion: DETECTED' : 'Motion: None';
        },
      },
      light: {
        name: 'Smart Light',
        genReading(d) {
          d.brightness = clamp((d.brightness ?? randi(20, 80)) + randi(-10, 10), 0, 100);
          d.powerDraw = clamp((d.powerDraw ?? rand(3, 8)) + rand(-0.8, 0.9), 0, 20);
          return `Brightness ${d.brightness}% / ${d.powerDraw.toFixed(1)}W`;
        },
      },
      door: {
        name: 'Door Sensor',
        genReading(d) {
          const open = Math.random() < 0.1; // 10% chance
          d.open = open;
          return open ? 'Door: OPEN' : 'Door: CLOSED';
        }
      },
    };

    // Device store
    const Store = {
      devices: [],
      alerts: [],
    };

    // --- Alert Engine ("Gemini Heuristics") --- //
    // This is a lightweight rules engine inspired by industry heuristics for IoT ops.
    function geminiHeuristics(device, prevSnapshot) {
      const alerts = [];
      const now = new Date();
      const hours = now.getHours();
      const offHours = (hours >= 22 || hours < 6);

      const pushAlert = (severity, title, rationale) => {
        alerts.push({
          id: crypto.randomUUID(),
          severity, // 'info' | 'warn' | 'crit'
          title,
          body: rationale,
          time: nowIso(),
          deviceId: device.id,
          deviceName: device.name,
          type: device.type,
        });
      };

      // Common heuristics
      if (!device.online) {
        pushAlert('crit', `${device.name} offline`, 'Device reported offline; risk of data loss and control unavailability. Heuristic: heartbeats missed.');
      }
      if (device.battery <= 15) {
        pushAlert('warn', `${device.name} low battery`, `Battery at ${device.battery}% — below 15% low‑power threshold. Heuristic: proactive replacement to avoid brownouts.`);
      }
      if (prevSnapshot) {
        const ageMs = Math.max(0, new Date(device.lastSeen) - new Date(prevSnapshot.lastSeen));
        if (ageMs < 0) {
          pushAlert('info', `${device.name} time drift`, 'Detected timestamp anomaly (clock moved backwards). Heuristic: NTP sync needed.');
        }
      }

      // Type-specific heuristics
      if (device.type === 'temperature') {
        const t = device.temp ?? 0;
        const h = device.humidity ?? 0;
        if (t > 45) {
          pushAlert('crit', `${device.name} high temperature`, `Temperature ${t.toFixed(1)}°C exceeds critical threshold (>45°C). Risk: thermal damage.`);
        } else if (t > 35) {
          pushAlert('warn', `${device.name} elevated temperature`, `Temperature ${t.toFixed(1)}°C above comfort range (>35°C). Heuristic: HVAC anomaly or sensor drift.`);
        }
        if (h < 15 || h > 85) {
          pushAlert('warn', `${device.name} humidity out of range`, `Humidity ${h.toFixed(0)}% outside safe range (15–85%). Risk: ESD/corrosion.`);
        }
        if (prevSnapshot && prevSnapshot.temp !== undefined) {
          const delta = Math.abs((device.temp ?? 0) - (prevSnapshot.temp ?? 0));
          if (delta > 8) {
            pushAlert('warn', `${device.name} temp spike`, `ΔTemp ${delta.toFixed(1)}°C within one interval — anomaly spike heuristic.`);
          }
        }
      }

      if (device.type === 'motion') {
        if (device.motion && offHours) {
          pushAlert('crit', `${device.name} motion after-hours`, 'Motion detected during quiet hours (22:00–06:00). Heuristic: potential intrusion.');
        } else if (device.motion) {
          pushAlert('info', `${device.name} motion observed`, 'Motion detected; logging for analytics. Heuristic: occupancy event.');
        }
      }

      if (device.type === 'light') {
        if (device.powerCycles && device.powerCycles >= 3) {
          pushAlert('warn', `${device.name} frequent power cycles`, `${device.powerCycles} toggles in last 10 minutes. Heuristic: unstable power or firmware watchdog.`);
        }
        const w = device.powerDraw ?? 0;
        if (w > 15) {
          pushAlert('warn', `${device.name} high power draw`, `Power draw ${w.toFixed(1)}W exceeds expected envelope (>15W). Risk: overheating.`);
        }
      }

      if (device.type === 'door') {
        if (device.open && offHours) {
          pushAlert('crit', `${device.name} opened after-hours`, 'Door opened during restricted window (22:00–06:00). Heuristic: access policy violation.');
        }
      }

      return alerts;
    }

    // --- Rendering --- //
    const grid = $('#deviceGrid');
    const alertList = $('#alertList');

    function renderStats() {
      const total = Store.devices.length;
      const online = Store.devices.filter(d => d.online).length;
      const offline = total - online;
      const alerts = Store.alerts.length;
      $('#statTotal').textContent = total;
      $('#statOnline').textContent = online;
      $('#statOffline').textContent = offline;
      $('#statAlerts').textContent = alerts;
      $('#alertCountBadge').textContent = alerts;
    }

    function statusPill(status) {
      if (status === 'online') return 'bg-emerald-100 text-emerald-700';
      if (status === 'rebooting') return 'bg-indigo-100 text-indigo-700';
      return 'bg-rose-100 text-rose-700';
    }

    function createDeviceCard(device) {
      const tpl = $('#deviceCardTpl').content.cloneNode(true);
      const card = tpl.querySelector('.device-card');
      card.dataset.id = device.id;
      $('.device-name', card).textContent = device.name;
      $('.device-type', card).textContent = DEVICE_TYPES[device.type].name;

      const statusEl = $('.device-status', card);
      const sensorEl = $('.device-sensor', card);
      const batteryEl = $('.device-battery', card);
      const lastSeenEl = $('.device-lastseen', card);
      const powerEl = $('.device-power', card);

      function updateCard() {
        const st = device.online ? (device.rebooting ? 'rebooting' : 'online') : 'offline';
        statusEl.textContent = st;
        statusEl.className = `device-status inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full ${statusPill(st)}`;

        sensorEl.textContent = device.readingText ?? '—';
        batteryEl.textContent = `${device.battery}%`;
        lastSeenEl.textContent = device.lastSeen ? fmtTime(device.lastSeen) : '—';
        powerEl.textContent = device.powered ? 'ON' : 'OFF';
      }

      // Bind actions
      $('.btn-toggle', card).addEventListener('click', () => {
        device.powered = !device.powered;
        if (!device.powered) {
          device.online = false;
          device.rebooting = false;
        } else {
          device.online = true;
        }
        device.powerCyclesLog.push(Date.now());
        pruneCycles(device);
        device.powerCycles = device.powerCyclesLog.length;
        updateCard();
        runHeuristics(device);
        renderStats();
      });

      $('.btn-reboot', card).addEventListener('click', () => {
        if (!device.powered) return; // can't reboot when off
        device.rebooting = true;
        device.online = true;
        updateCard();
        setTimeout(() => {
          device.rebooting = false;
          device.online = true;
          device.lastSeen = nowIso();
          updateCard();
          pushAlerts(geminiHeuristics(device));
          renderStats();
        }, 1500);
      });

      $('.btn-simulate', card).addEventListener('click', () => {
        simulateDevice(device, { forceUpdate: true });
      });

      updateCard();
      return card;
    }

    function updateDeviceCard(device) {
      const card = grid.querySelector(`.device-card[data-id="${device.id}"]`);
      if (!card) return;
      const statusEl = $('.device-status', card);
      const sensorEl = $('.device-sensor', card);
      const batteryEl = $('.device-battery', card);
      const lastSeenEl = $('.device-lastseen', card);
      const powerEl = $('.device-power', card);

      const st = device.online ? (device.rebooting ? 'rebooting' : 'online') : 'offline';
      statusEl.textContent = st;
      statusEl.className = `device-status inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full ${statusPill(st)}`;

      sensorEl.textContent = device.readingText ?? '—';
      batteryEl.textContent = `${device.battery}%`;
      lastSeenEl.textContent = device.lastSeen ? fmtTime(device.lastSeen) : '—';
      powerEl.textContent = device.powered ? 'ON' : 'OFF';
    }

    // Alerts rendering
    function severityStyles(sev) {
      switch (sev) {
        case 'crit': return { bar: 'bg-rose-500', pill: 'bg-rose-100 text-rose-700' };
        case 'warn': return { bar: 'bg-amber-500', pill: 'bg-amber-100 text-amber-700' };
        default: return { bar: 'bg-sky-500', pill: 'bg-sky-100 text-sky-700' };
      }
    }

    function renderAlertItem(a) {
      const tpl = $('#alertItemTpl').content.cloneNode(true);
      $('[data-title]', tpl).textContent = `${a.title}`;
      $('[data-body]', tpl).textContent = `${a.body} (Device: ${a.deviceName}, Type: ${DEVICE_TYPES[a.type].name})`;
      $('[data-time]', tpl).textContent = fmtTime(a.time);
      const styles = severityStyles(a.severity);
      $('[data-severity-bar]', tpl).className = `shrink-0 w-2 rounded-lg ${styles.bar}`;
      $('[data-severity-pill]', tpl).className = `text-[10px] uppercase tracking-wide px-2 py-0.5 rounded-full ${styles.pill}`;
      $('[data-severity-pill]', tpl).textContent = a.severity;
      const li = tpl.querySelector('li');
      $('[data-dismiss]', li).addEventListener('click', () => {
        Store.alerts = Store.alerts.filter(x => x.id !== a.id);
        li.remove();
        renderStats();
      });
      return li;
    }

    function pushAlerts(newAlerts) {
      if (!newAlerts || !newAlerts.length) return;
      newAlerts.forEach(a => {
        Store.alerts.unshift(a);
        alertList.prepend(renderAlertItem(a));
      });
      renderStats();
    }

    // --- Simulation & Auto-Refresh --- //
    function pruneCycles(device) {
      // Keep only last 10 minutes of power cycles for heuristic
      const cutoff = Date.now() - 10 * 60 * 1000;
      device.powerCyclesLog = device.powerCyclesLog.filter(ts => ts >= cutoff);
    }

    function simulateDevice(device, { forceUpdate = false } = {}) {
      // Keep a snapshot for change detection
      const prev = { temp: device.temp, humidity: device.humidity, lastSeen: device.lastSeen };

      if (!device.powered) {
        device.online = false;
        device.readingText = '—';
      } else {
        device.online = true;
        const def = DEVICE_TYPES[device.type];
        device.readingText = def.genReading(device);
        // Battery drains slightly when powered. Faster drain if online.
        device.battery = clamp(device.battery - (device.online ? rand(0.1, 0.6) : rand(0.02, 0.2)), 0, 100);
        device.battery = Math.round(device.battery);
        device.lastSeen = nowIso();
      }

      pruneCycles(device);
      device.powerCycles = device.powerCyclesLog.length;

      updateDeviceCard(device);
      // Run heuristics and push alerts
      pushAlerts(geminiHeuristics(device, prev));
    }

    let refreshTimer = null;
    function setAutoRefresh(intervalMs) {
      if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
      if (!intervalMs || intervalMs === 'off') return;
      refreshTimer = setInterval(() => {
        Store.devices.forEach(d => simulateDevice(d));
      }, Number(intervalMs));
    }

    // --- Device Factory --- //
    let deviceSeq = 1;
    function makeDevice(type) {
      const id = crypto.randomUUID();
      const name = `${DEVICE_TYPES[type].name} #${deviceSeq++}`;
      const powered = Math.random() > 0.08;
      const d = {
        id, name, type, powered,
        online: powered,
        rebooting: false,
        battery: randi(40, 100),
        lastSeen: nowIso(),
        readingText: '',
        powerCyclesLog: [],
        powerCycles: 0,
      };
      // Prime one reading
      d.readingText = DEVICE_TYPES[type].genReading(d);
      return d;
    }

    function addDevice(type = sample(Object.keys(DEVICE_TYPES))) {
      const device = makeDevice(type);
      Store.devices.push(device);
      grid.prepend(createDeviceCard(device));
      renderStats();
      // Run an initial heuristic pass (e.g., low battery at creation)
      pushAlerts(geminiHeuristics(device));
      return device;
    }

    // Seed a few demo devices on load
    function seedDevices() {
      ['temperature','motion','light','door','temperature','light'].forEach(t => addDevice(t));
    }

    // --- Event Wiring --- //
    $('#addDeviceBtn').addEventListener('click', () => addDevice());
    $('#refreshNowBtn').addEventListener('click', () => {
      Store.devices.forEach(d => simulateDevice(d, { forceUpdate: true }));
    });
    $('#refreshSelect').addEventListener('change', (e) => setAutoRefresh(e.target.value));
    $('#clearAlertsBtn').addEventListener('click', () => { Store.alerts = []; alertList.innerHTML = ''; renderStats(); });
    $('#seedAlertsBtn').addEventListener('click', () => {
      // Generate a few fake alerts to show structure
      const sampleDevice = Store.devices[0];
      if (!sampleDevice) return;
      pushAlerts([
        { id: crypto.randomUUID(), severity: 'info', title: 'Demo notice', body: 'Heuristic: scheduled maintenance window reminder.', time: nowIso(), deviceId: sampleDevice.id, deviceName: sampleDevice.name, type: sampleDevice.type },
        { id: crypto.randomUUID(), severity: 'warn', title: 'Demo warning', body: 'Heuristic: firmware update pending > 30 days.', time: nowIso(), deviceId: sampleDevice.id, deviceName: sampleDevice.name, type: sampleDevice.type },
      ]);
    });

    // --- Init --- //
    seedDevices();
    renderStats();

    // Default auto-refresh interval (10s)
    $('#refreshSelect').value = '10000';
    setAutoRefresh(10000);
  </script>
</body>
</html>
